<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ICS Academic Repository</title>

    <!-- Fonts & Preconnects -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://drive.google.com" />
    <link rel="preconnect" href="https://docs.google.com" />

    <style>
      :root {
        /* Light theme */
        --background: #f5f7fb;
        --surface: #ffffff;
        --tile-bg: #1e40af;
        --text: #0f172a;
        --muted: #64748b;
        --primary: #2563eb;
        --secondary: #dbe1f9; /* sidebar buttons */
        --secondary-hover: #c7cff5; /* hover */
        --border: #e5e7eb;
        --ring: #c7d2fe;
        --shadow: 0 8px 24px rgba(2, 6, 23, 0.08);
        --radius: 10px;
        --wave-a: #2c1e92;
        --wave-b: #e27478;
        --avatar-size: 120px; /* circle diameter (increase to 140px/160px if you want even bigger) */
        --avatar-ring: 4px; /* white ring thickness around the photos */
        --wave-height: 180px; /* height of the SVG waves */
        --credits-pad-y: 96px;
        --subject-border: #1f3ea1;
      }

      /* Improved dark mode palette (higher contrast + softer surfaces) */
      [data-theme="dark"] {
        --background: #0b1323; /* page background */
        --surface: #101b30; /* cards/surfaces */
        --tile-bg: #122b57; /* tile top (indigo-500) */
        --text: #e8eef8; /* primary text */
        --muted: #9fb0c3; /* secondary text */
        --primary: #7aa2ff; /* buttons */
        --secondary: #132441; /* sidebar tabs */
        --secondary-hover: #18345e; /* sidebar hover */
        --border: #21324a; /* subtle borders */
        --ring: #3b6cf6; /* focus ring */
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
        --wave-a: #243b6b; /* footer wave 1 */
        --wave-b: #b24a6a; /* footer wave 2 */
        --subject-border: #162c53;
      }

      * {
        box-sizing: border-box;
        font-family: "Roboto", sans-serif;
      }
      body {
        margin: 0;
        background: var(--background);
        color: var(--text);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Navbar - Mobile Responsive */
      nav {
        background: linear-gradient(90deg, #2c1e92 0%, #e27478 100%);
        color: #fff;
        padding: 0.8rem 1rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      nav img {
        height: 40px;
        flex-shrink: 0;
      }
      .nav-title {
        flex: 1;
        min-width: 200px;
        font-size: 1.1rem;
        text-align: center;
      }
      .logo-title {
        display: flex;
        flex: 1;
      }
      .theme-toggle {
        border: 1px solid rgba(255, 255, 255, 0.6);
        background: #1e40af;
        color: #fff;
        padding: 0.45rem 0.75rem;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 800;
        white-space: nowrap;
      }
      .theme-toggle:hover {
        background: #2563eb;
      }

      /* Mobile Navigation for Detail View */
      .mobile-nav {
        display: none;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .mobile-nav-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .mobile-back-btn {
        background: var(--primary);
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 700;
        cursor: pointer;
      }
      .mobile-menu-btn {
        background: var(--secondary);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 700;
        cursor: pointer;
      }
      .mobile-tabs {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 4px;
      }
      .mobile-tabs::-webkit-scrollbar {
        height: 3px;
      }
      .mobile-tabs::-webkit-scrollbar-track {
        background: transparent;
      }
      .mobile-tabs::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      .mobile-tab {
        background: var(--secondary);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
        font-size: 0.9rem;
      }
      .mobile-tab.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      /* Mobile Sidebar Overlay */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 200;
      }
      .sidebar-drawer {
        position: fixed;
        top: 0;
        right: -300px;
        width: 280px;
        height: 100vh;
        background: var(--surface);
        box-shadow: var(--shadow);
        transition: right 0.3s ease;
        overflow-y: auto;
        z-index: 201;
        padding: 16px;
      }
      .sidebar-drawer.open {
        right: 0;
      }
      .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }
      .close-drawer {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text);
      }

      /* Tiles - Responsive Grid */

      .subject-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
        border: var(--subject-border) 2px solid;
        padding: 8px;
        border-radius: 12px;
      }

      .course-grid {
        display: flex; /* yeh outer wrapper hai */
        flex-direction: column;
        gap: 24px;
        padding: 20px;
        justify-content: center;
      }
      .course-tile {
        display: flex;
        flex-direction: column;
        height: 220px; /* total card height */
        border-radius: 8px;
        box-shadow: var(--shadow);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .tile-top {
        background: var(--tile-bg);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.25rem;
        text-align: center;
        padding: 16px;
        flex: 1; /* grows but smaller share */
      }

      .tile-bottom {
        background: var(--surface);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 16px;
        flex: 1.2; /* slightly larger than top */
      }
      .course-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
        text-align: center;
      }
      .course-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        background: var(--secondary);
        color: var(--text);
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      .course-btn:hover {
        background: var(--secondary-hover);
      }

      /* Detail view - Responsive Layout */
      .detail-container {
        display: none;
        padding: 0;
      }
      .desktop-sidebar {
        display: flex;
        flex-direction: column;
        gap: 12px;
        /* width:300px; */
        padding: 16px;
        background: var(--surface);
        border-right: 1px solid var(--border);
      }
      .tabs-main,
      .tabs-sub {
        display: flex;
        flex-direction: row;
        gap: 10px;
      }
      .tabs-sub {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed var(--border);
      }
      .tab-btn {
        width: 100%;
        background: var(--secondary);
        border: none;
        border-radius: 12px;
        padding: 12px;
        font-weight: 800;
        text-align: left;
        cursor: pointer;
        color: var(--text);
        transition: background 0.2s;
      }
      .tab-btn:hover {
        background: var(--secondary-hover);
      }
      .tab-btn.active {
        background: linear-gradient(
          180deg,
          rgba(59, 108, 246, 0.18),
          rgba(59, 108, 246, 0.1)
        );
        outline: 1px solid var(--border);
      }
      .subtab-btn {
        width: 92%;
        background: var(--secondary);
        border: none;
        border-radius: 999px;
        padding: 9px 12px;
        font-weight: 700;
        text-align: left;
        cursor: pointer;
        color: var(--text);
        margin-left: 8%;
      }
      .subtab-btn:hover {
        background: var(--secondary-hover);
      }
      .subtab-btn.active {
        background: linear-gradient(
          180deg,
          rgba(59, 108, 246, 0.18),
          rgba(59, 108, 246, 0.1)
        );
        outline: 1px solid var(--border);
      }

      .content {
        flex: 1;
        padding: 16px;
      }
      .back-btn {
        margin-bottom: 8px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        background: var(--primary);
        color: #fff;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }

      /* Content Grid - Responsive */
      .content-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
      }
      .search {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: var(--surface);
        color: var(--text);
        outline: none;
      }
      .search::placeholder {
        color: var(--muted);
      }
      .search:focus {
        box-shadow: 0 0 0 3px var(--ring);
        border-color: var(--ring);
      }
      .list-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 8px;
        max-height: calc(100vh - 220px);
        overflow-y: auto;
      }
      .resource-item {
        padding: 10px 14px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .resource-item:hover {
        background: rgba(59, 108, 246, 0.08);
      }
      .resource-title {
        font-weight: 800;
        color: var(--text);
        line-height: 1.2;
      }
      .resource-meta {
        font-size: 0.82rem;
        color: var(--muted);
        margin-top: 2px;
        line-height: 1.3;
      }
      .resource-info {
        flex: 1;
        min-width: 0;
      }
      .preview-chip {
        border: 1px solid var(--border);
        background: linear-gradient(
          180deg,
          rgba(59, 108, 246, 0.2),
          rgba(59, 108, 246, 0.1)
        );
        border-radius: 999px;
        padding: 4px 10px;
        font-weight: 800;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--text);
        white-space: nowrap;
      }

      .preview-shell {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 14px;
      }
      .preview-title {
        font-weight: 800;
        margin-bottom: 8px;
        color: var(--text);
        font-size: 1.05rem;
      }
      .preview-frame {
        width: 100%;
        height: 75vh;
        border: none;
        border-radius: 10px;
        background: #0f172a10;
      }
      .preview-empty {
        padding: 2rem;
        text-align: center;
        color: var(--muted);
      }

      /* Footer credits with waves */
      .credits-footer {
        position: relative;
        width: 100%;
        overflow: hidden;
        background: linear-gradient(135deg, var(--wave-a), var(--wave-b));
        color: #fff;
        margin-top: auto;
      }
      .credits-footer .waves {
        position: absolute;
        left: 0;
        top: -1px;
        width: 100%;
        height: var(--wave-height);
      }
      .credits-footer .waves svg {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
      }
      .credits-footer .wave-a path {
        fill: var(--wave-a);
        opacity: 0.85;
      }
      .credits-footer .wave-b path {
        fill: var(--wave-b);
        opacity: 0.75;
      }

      .credits-inner {
        position: relative;
        z-index: 2;
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--credits-pad-y) 24px 48px;
      }

      .credits-title {
        font-weight: 800;
        letter-spacing: 0.4px;
        margin: 0 0 16px;
        font-size: 1rem;
        opacity: 0.92;
        text-align: center;
      }

      .credits-avatars {
        display: flex;
        justify-content: center;
        gap: 36px;
        flex-wrap: wrap;
      }
      .credits-avatars .credit {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .credits-avatars .avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: var(--avatar-ring) solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.28);
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }
      .credits-avatars .avatar:hover {
        transform: scale(1.03);
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.32);
      }
      .credits-avatars .name {
        font-weight: 800;
        font-size: 1.05rem;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);
        text-align: center;
      }

      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        /* Navigation */
        .tabs-main,
        .tabs-sub {
          flex-direction: column;
        }
        nav {
          padding: 0.6rem 0.8rem;
          font-size: 0.95rem;
        }
        nav img {
          height: 32px;
        }
        .nav-title {
          font-size: 1rem;
          min-width: 150px;
        }
        .theme-toggle {
          padding: 0.4rem 0.6rem;
          font-size: 0.85rem;
        }

        /* Course Grid */
        .course-grid {
          grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
          gap: 12px;
          padding: 16px;
        }
        .course-tile {
          height: 200px;
        }
        .tile-top {
          font-size: 1rem;
          padding: 12px;
        }
        .tile-bottom {
          padding: 12px;
        }
        .course-name {
          font-size: 0.9rem;
        }

        /* Detail View Mobile */
        .detail-container {
          display: block !important;
          height: auto;
        }
        .desktop-sidebar {
          display: none;
        }
        .mobile-nav {
          display: block;
        }
        .back-btn {
          display: none;
        }

        /* Content adjustments */
        .content {
          padding: 0;
          overflow-y: visible;
        }
        .content-grid {
          display: block;
          padding: 16px;
          flex: none;
        }
        .list-card {
          margin-top: 16px;
          max-height: 40vh;
          height: 40vh;
        }
        .preview-shell {
          margin-top: 16px;
        }
        .preview-frame {
          height: 50vh;
          flex: none;
        }

        /* Resource items mobile optimization */
        .resource-item {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
          padding: 12px;
        }
        .resource-info {
          text-align: center;
        }
        .preview-chip {
          align-self: center;
          padding: 8px 16px;
        }

        /* Credits responsive */
        .credits-inner {
          padding: 48px 16px 24px;
        }
        .credits-avatars {
          gap: 24px;
        }
        .credits-avatars .avatar {
          width: 120px;
          height: 120px;
        }
        .credits-avatars .name {
          font-size: 0.95rem;
        }
      }

      @media (max-width: 480px) {
        /* Even smaller screens */
        .course-grid {
          grid-template-columns: 1fr;
          padding: 12px;
        }
        .course-tile {
          height: 180px;
        }
        .tile-top {
          font-size: 0.9rem;
        }
        .course-name {
          font-size: 0.85rem;
        }

        .mobile-nav {
          padding: 8px 12px;
        }
        .content-grid {
          padding: 12px;
        }

        .list-card {
          max-height: 35vh;
        }
        .preview-frame {
          height: 45vh;
        }

        .credits-avatars {
          gap: 20px;
        }
        .credits-avatars .avatar {
          width: 100px;
          height: 100px;
        }
      }

      /* Landscape mobile adjustments */
      @media (max-width: 768px) and (orientation: landscape) {
        .preview-frame {
          height: 60vh;
        }
        .list-card {
          max-height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav>
      <!-- <div class="logo-title"> -->
      <img src="static/logo.png" alt="ICS Logo" />
      <div
        class="nav-title"
        style="text-decoration: none; color: inherit"
      >
        Centralized Academic Repository
      </div>
      <!-- </div> -->
      <button
        id="themeToggle"
        class="theme-toggle"
        aria-label="Toggle dark mode"
      >
        <img
          src="static/moon.svg"
          alt="Theme Icon"
          style="height: 16px; vertical-align: middle; margin-right: 6px"
        />
        Dark
      </button>
    </nav>

    <!-- Mobile Navigation (only visible in detail view on mobile) -->
    <div class="mobile-nav" id="mobileNav">
      <div class="mobile-nav-header">
        <button class="mobile-back-btn" id="mobileBackBtn">
          ← Back to Courses
        </button>
        <button class="mobile-menu-btn" id="mobileMenuBtn">☰ Sections</button>
      </div>
      <div class="mobile-tabs" id="mobileTabs"></div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay">
      <div class="sidebar-drawer" id="sidebarDrawer">
        <div class="drawer-header">
          <h3>Sections</h3>
          <button class="close-drawer" id="closeDrawer">×</button>
        </div>
        <div class="tabs-main" id="drawerTabsMain"></div>
        <div class="tabs-sub" id="drawerTabsSub"></div>
      </div>
    </div>

    <!-- Tiles -->
    <div class="course-grid" id="courseGrid"></div>

    <!-- Detail View -->
    <div class="detail-container" id="detailView">
      <aside class="desktop-sidebar">
        <div class="tabs-main" id="tabsMain"></div>
        <div class="tabs-sub" id="tabsSub"></div>
      </aside>

      <main class="content">
        <button class="back-btn" id="backBtn">← Back to Courses</button>
        <h2 id="courseHeading">Select a section</h2>
        <div class="content-grid">
          <div>
            <input
              id="searchInput"
              class="search"
              placeholder="Search titles... (press Enter)"
            />
            <div id="listCard" class="list-card" style="margin-top: 10px">
              <div id="list"></div>
            </div>
          </div>
          <div class="preview-shell">
            <div id="previewTitle" class="preview-title">No item selected</div>
            <iframe id="preview" class="preview-frame" title="Preview"></iframe>
            <div id="emptyState" class="preview-empty">
              Choose a file from the list to preview it here.
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Credits Footer -->
    <footer id="creditsFooter" class="credits-footer">
      <div class="waves">
        <svg class="wave-a" viewBox="0 0 1440 120" preserveAspectRatio="none">
          <path
            d="M0,64 C240,96 480,0 720,32 C960,64 1200,128 1440,96 L1440,0 L0,0 Z"
          ></path>
        </svg>
        <svg class="wave-b" viewBox="0 0 1440 120" preserveAspectRatio="none">
          <path
            d="M0,96 C240,128 480,64 720,80 C960,96 1200,80 1440,112 L1440,0 L0,0 Z"
          ></path>
        </svg>
      </div>
      <div class="credits-inner">
        <h3 class="credits-title">Credits : ICS Web Team</h3>
        <div class="credits-avatars">
          <div class="credit">
            <img src="static/ketan.jpg" alt="Ketan Aggarwal" class="avatar" />
            <div class="name">Ketan Aggarwal</div>
          </div>
          <div class="credit">
            <img src="static/alok.jpg" alt="Aalok" class="avatar" />
            <div class="name">Aalok Tejas</div>
          </div>
          <div class="credit">
            <img
              src="static/srushtij.jpg"
              alt="Srushti Jagtap"
              class="avatar"
            />
            <div class="name">Srushti Jagtap</div>
          </div>
          <div class="credit">
            <img src="static/muragesh.jpg" alt="Muragesh" class="avatar" />
            <div class="name">Muragesh</div>
          </div>
          <div class="credit">
            <img src="static/aman.jpg" alt="Aman Sheoran" class="avatar" />
            <div class="name">Aman Sheoran</div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Data file -->
    <script src="data.js"></script>

    <!-- App -->
    <script>
      // Elements
      const courseGrid = document.getElementById("courseGrid");
      const detailView = document.getElementById("detailView");
      const tabsMain = document.getElementById("tabsMain");
      const tabsSub = document.getElementById("tabsSub");
      const courseHeading = document.getElementById("courseHeading");
      const list = document.getElementById("list");
      const preview = document.getElementById("preview");
      const previewTitle = document.getElementById("previewTitle");
      const emptyState = document.getElementById("emptyState");
      const searchInput = document.getElementById("searchInput");
      const backBtn = document.getElementById("backBtn");
      const themeToggle = document.getElementById("themeToggle");
      const credits = document.getElementById("creditsFooter");
      const htmlEl = document.documentElement;

      // Mobile elements
      const mobileNav = document.getElementById("mobileNav");
      const mobileBackBtn = document.getElementById("mobileBackBtn");
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const mobileTabs = document.getElementById("mobileTabs");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const sidebarDrawer = document.getElementById("sidebarDrawer");
      const closeDrawer = document.getElementById("closeDrawer");
      const drawerTabsMain = document.getElementById("drawerTabsMain");
      const drawerTabsSub = document.getElementById("drawerTabsSub");

      // State
      let currentCourse = null,
        currentMain = null,
        currentSub = null;
      let allItemsCache = [],
        filteredItems = [];

      // Theme persist
      function setThemeButton(isDark) {
        themeToggle.innerHTML = isDark
          ? `<img src="static/moon.svg" alt="Dark Mode" 
             style="width:18px;height:18px;vertical-align:middle;margin-right:6px;">
       Dark`
          : `<img src="static/sun.svg" alt="Light Mode" 
             style="width:18px;height:18px;vertical-align:middle;margin-right:6px;">
       Light`;
      }

      // Theme persist (on load)
      const savedTheme = localStorage.getItem("ics-theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      const isDark = savedTheme === "dark" || (!savedTheme && prefersDark);

      htmlEl.setAttribute("data-theme", isDark ? "dark" : "light");
      setThemeButton(isDark);

      // Toggle on click
      themeToggle.addEventListener("click", () => {
        const dark = htmlEl.getAttribute("data-theme") === "dark";
        htmlEl.setAttribute("data-theme", dark ? "light" : "dark");
        localStorage.setItem("ics-theme", dark ? "light" : "dark");
        setThemeButton(!dark);
      });

      // Mobile sidebar controls
      mobileMenuBtn.addEventListener("click", () => {
        sidebarOverlay.style.display = "block";
        setTimeout(() => sidebarDrawer.classList.add("open"), 10);
      });

      function closeSidebar() {
        sidebarDrawer.classList.remove("open");
        setTimeout(() => (sidebarOverlay.style.display = "none"), 300);
      }

      closeDrawer.addEventListener("click", closeSidebar);
      sidebarOverlay.addEventListener("click", (e) => {
        if (e.target === sidebarOverlay) closeSidebar();
      });

      // Utils
      function escapeHTML(str) {
        return String(str).replace(
          /[&<>"]/g,
          (s) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[s])
        );
      }
      function isDrive(url) {
        return /drive\.google\.com\//i.test(url);
      }
      function isNative(url) {
        return /\.(pdf|png|jpe?g|gif|webp|mp4|mp3|wav|m4a)(\?|#|$)/i.test(url);
      }
      function buildPreviewURL(url) {
        if (isDrive(url)) return url.replace("/view", "/preview");
        if (isNative(url)) return url;
        return `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(
          url
        )}`;
      }

      function collectFiles(node, path = [], out = []) {
        if (!node) return out;
        if (Array.isArray(node)) {
          node.forEach((it) => out.push({ ...it, _path: path.join(" / ") }));
          return out;
        }
        if (typeof node === "object") {
          if (Array.isArray(node.files))
            node.files.forEach((f) =>
              out.push({ ...f, _path: path.join(" / ") })
            );
          Object.keys(node).forEach((k) => {
            if (k !== "files") collectFiles(node[k], path.concat(k), out);
          });
        }
        return out;
      }

      // Build tiles
      function loadCourses() {
        courseGrid.innerHTML = "";

        if (typeof data !== "object" || !data) {
          courseGrid.innerHTML =
            '<div style="padding:1rem;color:crimson;font-weight:700">Error: data.js must define <code>const data = {...}</code></div>';
          return;
        }

        // Group courses by subject
        const subjects = {};
        Object.keys(data).forEach((code) => {
          const course = data[code];
          const subj = course.subject || "Other";
          if (!subjects[subj]) subjects[subj] = [];
          subjects[subj].push(course);
        });

        // Render each subject section
        Object.keys(subjects).forEach((subj) => {
          const section = document.createElement("div");
          section.className = "subject-section";

          // Course row
          const row = document.createElement("div");
          row.className = "subject-row";

          subjects[subj].forEach((course) => {
            const card = document.createElement("div");
            card.className = "course-tile";
            card.innerHTML = `
        <div class="tile-top">${escapeHTML(course.code || "")}</div>
        <div class="tile-bottom">
          <div class="course-name">${escapeHTML(course.name || "")}</div>
          <button class="course-btn">Access Course</button>
        </div>`;
            card
              .querySelector(".course-btn")
              .addEventListener("click", () => openCourse(course));
            row.appendChild(card);
          });

          section.appendChild(row);
          courseGrid.appendChild(section);
        });

        credits.style.display = "block";
      }

      // Tab helpers
      function mkMainTab(name, isDrawer = false) {
        const b = document.createElement("button");
        b.className = "tab-btn";
        b.textContent = name;
        b.addEventListener("click", () => {
          selectMain(name);
          if (isDrawer) closeSidebar();
        });
        return b;
      }

      function mkSubTab(name, isDrawer = false) {
        const b = document.createElement("button");
        b.className = "subtab-btn";
        b.textContent = name;
        b.addEventListener("click", () => {
          selectSub(name);
          if (isDrawer) closeSidebar();
        });
        return b;
      }

      function mkMobileTab(name) {
        const b = document.createElement("button");
        b.className = "mobile-tab";
        b.textContent = name;
        b.addEventListener("click", () => selectMain(name));
        return b;
      }

      // Decide if subtabs should show (hide numeric/flat arrays & specific sections)
      function shouldShowSubtabs(name, node) {
        const deny = ["quizzes", "quiz", "quizzes and endsem", "pyqs", "pyq"];
        if (deny.includes(String(name).toLowerCase())) return false;
        if (!node || typeof node !== "object" || Array.isArray(node))
          return false;
        const subKeys = Object.keys(node).filter(
          (k) => k !== "files" && !Array.isArray(node[k]) && !/^\d+$/.test(k)
        );
        return subKeys.length >= 2; // only if 2+ real categories
      }

      function selectMain(name) {
        currentMain = name;
        currentSub = null;

        // Update desktop tabs
        Array.from(tabsMain.querySelectorAll(".tab-btn")).forEach((x) =>
          x.classList.remove("active")
        );
        const active = Array.from(tabsMain.querySelectorAll(".tab-btn")).find(
          (x) => x.textContent === name
        );
        if (active) active.classList.add("active");

        // Update drawer tabs
        Array.from(drawerTabsMain.querySelectorAll(".tab-btn")).forEach((x) =>
          x.classList.remove("active")
        );
        const activeDrawer = Array.from(
          drawerTabsMain.querySelectorAll(".tab-btn")
        ).find((x) => x.textContent === name);
        if (activeDrawer) activeDrawer.classList.add("active");

        // Update mobile tabs
        Array.from(mobileTabs.querySelectorAll(".mobile-tab")).forEach((x) =>
          x.classList.remove("active")
        );
        const activeMobile = Array.from(
          mobileTabs.querySelectorAll(".mobile-tab")
        ).find((x) => x.textContent === name);
        if (activeMobile) activeMobile.classList.add("active");

        // Clear subtabs
        tabsSub.innerHTML = "";
        drawerTabsSub.innerHTML = "";

        if (name !== "All") {
          const node = currentCourse.resources?.[name];
          if (shouldShowSubtabs(name, node)) {
            const subKeys = Object.keys(node).filter(
              (k) =>
                k !== "files" && !Array.isArray(node[k]) && !/^\d+$/.test(k)
            );

            // Desktop subtabs
            const allSub = mkSubTab("All in " + name);
            tabsSub.appendChild(allSub);
            subKeys.forEach((k) => tabsSub.appendChild(mkSubTab(k)));

            // Drawer subtabs
            const allSubDrawer = mkSubTab("All in " + name, true);
            drawerTabsSub.appendChild(allSubDrawer);
            subKeys.forEach((k) =>
              drawerTabsSub.appendChild(mkSubTab(k, true))
            );

            setTimeout(() => allSub.click());
          }
        }
        renderForCurrentSelection();
      }

      function selectSub(name) {
        currentSub = name;

        // Update desktop subtabs
        Array.from(tabsSub.querySelectorAll(".subtab-btn")).forEach((x) =>
          x.classList.remove("active")
        );
        const active = Array.from(tabsSub.querySelectorAll(".subtab-btn")).find(
          (x) => x.textContent === name
        );
        if (active) active.classList.add("active");

        // Update drawer subtabs
        Array.from(drawerTabsSub.querySelectorAll(".subtab-btn")).forEach((x) =>
          x.classList.remove("active")
        );
        const activeDrawer = Array.from(
          drawerTabsSub.querySelectorAll(".subtab-btn")
        ).find((x) => x.textContent === name);
        if (activeDrawer) activeDrawer.classList.add("active");

        renderForCurrentSelection();
      }

      function renderForCurrentSelection() {
        let items = [];
        if (currentMain === "All") {
          items = collectFiles(currentCourse.resources, []);
        } else {
          const mainNode = currentCourse.resources?.[currentMain];
          if (!currentSub || currentSub === "All in " + currentMain) {
            items = collectFiles(mainNode, [currentMain]);
          } else {
            const subNode = mainNode?.[currentSub];
            items = collectFiles(subNode, [currentMain, currentSub]);
          }
        }
        allItemsCache = items.slice();
        filteredItems = items;
        renderList(filteredItems);
        setPreview(null);
        searchInput.value = "";
      }

      function renderList(items) {
        list.innerHTML = "";
        if (!items || items.length === 0) {
          list.innerHTML = '<div class="preview-empty">No items</div>';
          return;
        }
        items.forEach((it) => {
          const row = document.createElement("div");
          row.className = "resource-item";
          row.innerHTML = `
          <div class="resource-info">
            <div class="resource-title">${escapeHTML(
              it.title || "Untitled"
            )}</div>
            <div class="resource-meta">${escapeHTML(it._path || "")}</div>
          </div>
          <button class="preview-chip">Preview</button>`;
          row
            .querySelector(".preview-chip")
            .addEventListener("click", () => setPreview(it));
          list.appendChild(row);
        });
      }

      function setPreview(item) {
        if (!item) {
          preview.src = "";
          previewTitle.textContent = "No item selected";
          emptyState.style.display = "block";
          return;
        }
        previewTitle.textContent = item.title || "Untitled";
        emptyState.style.display = "none";
        preview.src = buildPreviewURL(String(item.link || ""));
      }

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const q = searchInput.value.trim().toLowerCase();
          filteredItems = q
            ? allItemsCache.filter((r) =>
                (r.title || "").toLowerCase().includes(q)
              )
            : allItemsCache.slice();
          renderList(filteredItems);
          setPreview(null);
        }
      });

      function goBackToCourses() {
        // Clear all state
        currentCourse = null;
        currentMain = null;
        currentSub = null;
        allItemsCache = [];
        filteredItems = [];

        // Clear all tab containers
        tabsMain.innerHTML = "";
        tabsSub.innerHTML = "";
        drawerTabsMain.innerHTML = "";
        drawerTabsSub.innerHTML = "";
        mobileTabs.innerHTML = "";

        // Clear content areas
        list.innerHTML = "";
        preview.src = "";
        previewTitle.textContent = "No item selected";
        emptyState.style.display = "block";
        searchInput.value = "";
        courseHeading.textContent = "Select a section";

        // Close mobile sidebar if open
        closeSidebar();

        // Show course grid, hide detail view
        detailView.style.display = "none";
        courseGrid.style.display = "";
        credits.style.display = "block";
      }

      backBtn.addEventListener("click", goBackToCourses);
      mobileBackBtn.addEventListener("click", goBackToCourses);

      function openCourse(course) {
        currentCourse = course;
        courseGrid.style.display = "none";
        credits.style.display = "none";
        detailView.style.display = window.innerWidth <= 768 ? "block" : "grid";

        courseHeading.textContent = `${escapeHTML(
          course.code || ""
        )} – ${escapeHTML(course.name || "")}`;

        // Clear all tabs
        tabsMain.innerHTML = "";
        tabsSub.innerHTML = "";
        drawerTabsMain.innerHTML = "";
        drawerTabsSub.innerHTML = "";
        mobileTabs.innerHTML = "";

        // Create tabs for all containers
        const allBtn = mkMainTab("All");
        const allBtnDrawer = mkMainTab("All", true);
        const allBtnMobile = mkMobileTab("All");

        tabsMain.appendChild(allBtn);
        drawerTabsMain.appendChild(allBtnDrawer);
        mobileTabs.appendChild(allBtnMobile);

        Object.keys(course.resources || {}).forEach((k) => {
          tabsMain.appendChild(mkMainTab(k));
          drawerTabsMain.appendChild(mkMainTab(k, true));
          mobileTabs.appendChild(mkMobileTab(k));
        });

        setTimeout(() => allBtn.click());
      }

      // Handle window resize
      window.addEventListener("resize", () => {
        if (window.innerWidth > 768) {
          // Desktop mode
          if (detailView.style.display !== "none") {
            detailView.style.display = "grid";
          }
          closeSidebar();
        } else {
          // Mobile mode
          if (detailView.style.display !== "none") {
            detailView.style.display = "block";
          }
        }
      });

      // Start
      loadCourses();
    </script>
  </body>
</html>
